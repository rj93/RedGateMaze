<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="robots" content="noindex, nofollow">
	<meta name="revisit-after" content="7 days">

	<link rel="stylesheet" href="./css/bootstrap.min.css">
	<link rel="stylesheet" href="./css/website.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet"> 

	<link rel="stylesheet" href="./fonts/font-awesome/css/font-awesome.min.css">

	<script type="text/javascript" src="./js/jquery.min.js"></script>
	<script type="text/javascript" src="./js/bootstrap.min.js"></script>
	<script type="text/javascript" src="./js/website.js"></script>

	<title>Red Gate Maze Challenge</title>

	
</head>

	<body>
		<div class="container">
			
			<div id="controls">
				<div class="row">
					<div class="col-xs-4 col-md-2">
						<div class="input-group">
							<span class="input-group-addon" id="width-addon">Width</span>
							<input type="number" class="form-control" id="width" min="5" max="50" value="20" aria-describedby="width-addon">
						</div>
					</div>

					<div class="col-xs-4 col-md-2">
						<div class="input-group">
							<span class="input-group-addon" id="height-addon">Height</span>
							<input type="number" class="form-control" id="height" min="5" max="50" value="20" aria-describedby="height-addon">
						</div>
					</div>

						<button type="button" class="btn btn-primary" onclick="maze.generate()">Generate</button>
	
						<button type="button" class="btn btn-warning" onclick="initMaze()">Reset</button>
		
				</div>

				<div class="row">
			<div id="maze"></div>
		</div>
	</body>

	<script type="text/javascript">

		class Maze {
			constructor (width, height) {
				this.width = width;
				this.height = height;
				this.grid = [];
				for(var row=0; row<height; row++) {
					this.grid[row] = [];
					for(var col=0; col<width; col++) {
						this.grid[row][col] = new Cell(row, col);
					}
				}
				this.start = this.grid[0][0];
				this.end = this.grid[height-1][width-1];

				this.start.removeWallTop();
				this.start.addClass("start");
				this.end.removeWallBottom();
				this.end.addClass("end");
			}

			generate() {
				var stack = [];
				var iteration = 0;
				var cell, neighbours;

				stack.push(this.grid[0][0]);

				while(stack.length > 0){
					cell = stack.pop();
					cell.visit();

					if (!(cell.row == this.end.row && cell.col == this.end.col)){ // without this check there is the possibility for the end cell to be missing three walls

						var neighbours = this.getNeighbours(cell);
						if (neighbours.length > 1){ // JS array doesn't have a peek, so need to re-add the cell if it still has unexplored neighbours
							stack.push(cell);
						}

						var next = neighbours[Math.floor(Math.random() * neighbours.length)];
						if (next){
							stack.push(next);
							if (cell.getRow() < next.getRow()){ // next is below
								cell.removeWallBottom();
								next.removeWallTop();
							} else if (cell.getRow() > next.getRow()){ // next is above
								cell.removeWallTop();
								next.removeWallBottom();
							} else if (cell.getCol() < next.getCol()){ // next is to the right
								cell.removeWallRight();
								next.removeWallLeft();
							} else { // next is to the left
								cell.removeWallLeft();
								next.removeWallRight();
							}
						}
					}
					this.doSetTimeout(iteration);
					iteration++;
				}

			}

			doSetTimeout(i) {
				setTimeout(function() { console.log(i); }, 500);
			}

			getNeighbours(cell) {
				var row = cell.getRow();
				var col = cell.getCol();

				var neighbours = []
				if (row != 0) {
					// add top
					if (!this.grid[row-1][col].getVisited()){
						neighbours.push(this.grid[row-1][col]);
					}
				} 
				if (row != this.height - 1) {
					// add bottom
					if (!this.grid[row+1][col].getVisited()){
						neighbours.push(this.grid[row+1][col]);
					}
				}
				
				if (col != 0) {
					// add left
					if (!this.grid[row][col-1].getVisited()){
						neighbours.push(this.grid[row][col-1]);
					}
				} 
				if (col != this.width - 1){
					// add right
					if (!this.grid[row][col+1].getVisited()){
						neighbours.push(this.grid[row][col+1]);
					}
				}

				return neighbours;
			}
		}

		class Cell {
			constructor(row, col) {
				this.row = row;
				this.col = col;
				this.visited = false;
				this.wallTop = true;
				this.wallBottom = true;
				this.wallLeft = true;
				this.wallRight = true;
			}

			getRow() {
				return this.row;
			}

			getCol() {
				return this.col;
			}

			getCoordinates() {
				return {'row': this.row, 'col': this.col};
			}

			visit() {
				this.visited = true;
				this.addClass("visited");
			}

			getVisited() {
				return this.visited;
			}

			removeWallTop() {
				this.wallTop = false;
				this.addClass("no-wall-top");
			}

			removeWallBottom() {
				this.wallBottom = false;
				this.addClass("no-wall-bottom");
			}

			removeWallLeft() {
				this.wallLeft = false;
				this.addClass("no-wall-left");
			}

			removeWallRight() {
				this.wallRight = false;
				this.addClass("no-wall-right");
			}

			addClass(classToAdd) {
				$("#cell-" + this.row + "-" + this.col + ".cell").addClass(classToAdd);
			}

		}

			
		var width, height;
		var maze;


		$(document).ready(function() {
			initMaze();
		});

		$("#width").on('input', function() {
			initMaze();
		});

		$("#height").on('input', function() {
			initMaze();
		})

		function initMaze(){
			$("#maze").empty();
			width = $("#width").val();
			height = $("#height").val();
			$("#maze").css("min-width", width*10+"px"); // stop maze losing its structure on resize
			for(var row = 0; row < height; row++) {
				var mazeRow = $("<div class='row' id='row-"+row+"'></div>");
				mazeRow.appendTo("#maze")
				for(var col = 0; col < width; col++) {
					var unit = $("<div class='cell' id='cell-"+row+"-"+col+"'></div>");
					unit.appendTo("#row-"+row);
				}
			}
			maze = new Maze(width, height);
		}

	</script>

</html>